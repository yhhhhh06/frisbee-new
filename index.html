<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DiscMaster AI - å°ˆæ¥­é£›ç›¤æ•™ç·´</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>

    <style>
        :root { --primary: #00d2ff; --accent: #3a7bd5; --success: #00f260; --danger: #ff4b2b; --dark: #0f0f0f; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--dark); color: white; margin: 0; padding-bottom: 30px; }
        
        /* æ¨™é¡Œ */
        .app-header { padding: 15px; text-align: center; background: linear-gradient(135deg, var(--primary), var(--accent)); }
        .app-header h1 { margin: 0; font-size: 1.4rem; }

        .main-container { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 1200px; margin: 0 auto; padding: 10px; box-sizing: border-box; }

        /* è¦–è¨Šå€ */
        #display-box { position: relative; width: 100%; background: #000; border-radius: 15px; overflow: hidden; aspect-ratio: 16/9; border: 1px solid #333; }
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }

        /* --- æ•™ç·´å‹•æ…‹åé¥‹ (è­¦å‘Šå½ˆçª—) --- */
        #coach-feedback { 
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%); 
            width: 80%; background: rgba(255, 75, 43, 0.9); color: white; 
            padding: 10px; border-radius: 8px; text-align: center; 
            font-weight: bold; z-index: 100; display: none;
            box-shadow: 0 4px 15px rgba(255,0,0,0.3);
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.7;} 100% {opacity: 1;} }

        /* æ•¸æ“šæµ®å±¤ */
        .overlay-tag { position: absolute; background: rgba(0,0,0,0.7); padding: 5px 12px; border-radius: 8px; z-index: 10; font-size: 0.85rem; border-left: 3px solid var(--primary); }

        /* æ§åˆ¶æŒ‰éˆ• */
        .control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; width: 100%; margin: 15px 0; }
        .card { background: #1a1a1a; padding: 15px; border-radius: 12px; border: 1px solid #333; width: 100%; box-sizing: border-box; }
        
        button, .file-btn { background: var(--accent); border: none; padding: 12px 5px; color: white; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: 0.2s; text-align: center; }
        
        /* æ•™ç·´å°æé†’å€å¡Š (åŠ å¼·ç‰ˆ) */
        .hint-card { border-left: 5px solid var(--success); background: rgba(0, 242, 96, 0.05); }
        .hint-card h3 { color: var(--success); margin: 0 0 8px 0; font-size: 1rem; display: flex; align-items: center; }

        /* æ’ç‰ˆéŸ¿æ‡‰å¼ */
        @media (min-width: 900px) {
            .main-container { display: grid; grid-template-columns: 1fr 350px; gap: 20px; padding: 20px; }
        }

        .list-style { list-style: none; padding: 0; margin: 0; font-size: 0.9rem; }
        .list-style li { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

    <header class="app-header">
        <h1>ğŸ¥ DiscMaster AI Pro</h1>
    </header>

    <div class="main-container">
        <section style="width: 100%;">
            <div id="display-box">
                <div id="coach-feedback">âš ï¸ è­¦å‘Šï¼šæ‰‹è‚˜éå½ï¼è«‹ä¼¸ç›´</div>
                
                <div class="overlay-tag" style="top: 10px; left: 10px;">æ¬¡æ•¸ï¼š<span id="rep-count" style="font-size: 1.2rem; color: var(--success);">0</span></div>
                <div class="overlay-tag" style="top: 50px; left: 10px;">è§’åº¦ï¼š<span id="live-angle">0Â°</span></div>

                <video id="input_video" playsinline></video>
                <canvas id="output_canvas"></canvas>
            </div>

            <div class="control-grid">
                <button onclick="setupCamera()" style="background: var(--primary); color: #000;">ğŸ“¹ å•Ÿå‹• AI</button>
                <label class="file-btn" style="background: #444;">ğŸ“ å½±ç‰‡åˆ†æ<input type="file" hidden accept="video/*" onchange="loadFile(event)"></label>
                <button onclick="saveToHistory()" style="background: var(--danger);">ğŸ’¾ å„²å­˜æ•¸æ“š</button>
            </div>
        </section>

        <aside style="display: flex; flex-direction: column; gap: 15px; width: 100%;">
            <div class="card hint-card">
                <h3>ğŸ’¡ æ•™ç·´å°æé†’</h3>
                <p id="coach-hint" style="font-size: 0.85rem; line-height: 1.5; color: #ccc; margin: 0;">
                    æº–å‚™å¥½å¾Œï¼Œè«‹ç«™åœ¨è·é›¢é¡é ­ <span style="color:var(--primary)">2-3 å…¬å°º</span> è™•ï¼Œç¢ºä¿ AI èƒ½çœ‹åˆ°ä½ çš„å…¨èº«éª¨æ¶ï¼Œå³å¯è‡ªå‹•é–‹å§‹è¨ˆæ¬¡ã€‚
                </p>
            </div>

            <div class="card">
                <h3 style="color: var(--primary); margin: 0 0 10px 0; font-size: 1rem;">ğŸ† é›²ç«¯æ’è¡Œæ¦œ</h3>
                <ul id="leaderboard" class="list-style">
                    <li style="color:#666">é€£ç·šä¸­...</li>
                </ul>
            </div>

            <div class="card">
                <h3 style="color: var(--primary); margin: 0 0 10px 0; font-size: 1rem;">ğŸ“œ æ­·å²ç·´ç¿’</h3>
                <ul id="history-list" class="list-style">
                    <li style="color:#666">æš«ç„¡ç´€éŒ„</li>
                </ul>
            </div>
        </aside>
    </div>

    <script>
        // æ ¸å¿ƒé‚è¼¯ (è¨ˆç®—è§’åº¦ã€é¡¯ç¤ºè­¦å‘Šã€è»Œè·¡ç¹ªè£½)
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const feedbackEl = document.getElementById('coach-feedback');
        
        let repCount = 0;
        let isArmBent = false;
        let trajectory = [];

        const pose = new Pose({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}` });
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.6 });
        pose.onResults(onResults);

        function onResults(results) {
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                // ç•«éª¨æ¶
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#FFFFFF', lineWidth: 2});
                drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#00d2ff', radius: 3});

                // è¨ˆç®—æ‰‹è‚˜è§’åº¦
                const angle = calculateAngle(results.poseLandmarks[12], results.poseLandmarks[14], results.poseLandmarks[16]);
                document.getElementById('live-angle').innerText = `${Math.round(angle)}Â°`;

                // --- æ•™ç·´æé†’é‚è¼¯ ---
                if (angle < 130) {
                    feedbackEl.style.display = 'block'; // é¡¯ç¤ºç´…è‰²è­¦å‘Š
                    isArmBent = true;
                } else {
                    feedbackEl.style.display = 'none'; // é—œé–‰è­¦å‘Š
                    if (isArmBent && angle > 165) {
                        repCount++;
                        document.getElementById('rep-count').innerText = repCount;
                        isArmBent = false;
                    }
                }

                // ç•«è»Œè·¡
                const wrist = results.poseLandmarks[16];
                trajectory.push({x: wrist.x * canvasElement.width, y: wrist.y * canvasElement.height});
                if (trajectory.length > 15) trajectory.shift();
                drawTrajectory();
            }
            canvasCtx.restore();
        }

        function drawTrajectory() {
            if (trajectory.length < 2) return;
            canvasCtx.beginPath();
            canvasCtx.strokeStyle = '#00f260';
            canvasCtx.lineWidth = 5;
            canvasCtx.lineCap = 'round';
            canvasCtx.moveTo(trajectory[0].x, trajectory[0].y);
            trajectory.forEach(p => canvasCtx.lineTo(p.x, p.y));
            canvasCtx.stroke();
        }

        function calculateAngle(A, B, C) {
            let rad = Math.atan2(C.y - B.y, C.x - B.x) - Math.atan2(A.y - B.y, A.x - B.x);
            let deg = Math.abs(rad * 180 / Math.PI);
            return deg > 180 ? 360 - deg : deg;
        }

        async function setupCamera() {
            const cam = new Camera(videoElement, { onFrame: async () => await pose.send({image: videoElement}), width: 1280, height: 720 });
            cam.start();
        }

        function saveToHistory() {
            const history = JSON.parse(localStorage.getItem('frisbee_logs') || '[]');
            history.unshift({ date: new Date().toLocaleDateString(), count: repCount });
            localStorage.setItem('frisbee_logs', JSON.stringify(history.slice(0, 5)));
            location.reload(); // åˆ·æ–°é¡¯ç¤ºæ­·å²
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('frisbee_logs') || '[]');
            const el = document.getElementById('history-list');
            if (history.length > 0) {
                el.innerHTML = history.map(h => `<li><span>${h.date}</span> <span>${h.count}æ¬¡</span></li>`).join('');
            }
        }

        function loadFile(event) {
            const url = URL.createObjectURL(event.target.files[0]);
            videoElement.src = url;
            videoElement.play();
            videoElement.onplay = () => {
                async function process() { if(!videoElement.paused) { await pose.send({image:videoElement}); requestAnimationFrame(process); } }
                process();
            };
        }
        window.onload = loadHistory;
    </script>
</body>
</html>
